import{j as t,a as B,y as Y,b as Z,i as G,z as L,B as J,C as P,D as M}from"./ui-vendor-CFaKPCyu.js";import{r as o,u as K,h as Q}from"./react-vendor-CM6QddGd.js";import{u as U,a as V}from"./api.service-DhptIegH.js";import{g as X,b as ee,h as te,N as re}from"./index-WylA89_W.js";const h={singlePageSize:16,maxRequestTimeout:3e3};function ne(){const x=o.useRef(null),{videoAPIs:A}=X(),{getCachedResults:y,updateCachedResults:m}=ee(),q=K(),{query:p}=Q(),[c,v]=o.useState([]),[k,I]=o.useState(1),f=o.useMemo(()=>{const e=[];for(let r=0;r<c.length;r+=h.singlePageSize)e.push(c.slice(r,Math.min(r+h.singlePageSize,c.length)));return e||[]},[c]),[j,i]=o.useState(!0),u=o.useRef(null),[D,S]=o.useState(!1),b=o.useMemo(()=>A.filter(e=>e.isEnabled),[A]),z=o.useCallback(async e=>{if(!e)return;const r=async(a,d,C)=>{x.current?.abort();const R=new AbortController;x.current=R,u.current&&(clearTimeout(u.current),u.current=null),u.current=setTimeout(()=>{i(!1),u.current=null},h.maxRequestTimeout);const N=[...C];let E=!1;const O=V.aggregatedSearch(e,a,n=>{E=!0,v(l=>{const _=[...l,...n];return _.length>=h.singlePageSize&&i(!1),_}),Array.from(new Set(n.map(l=>l.source_code).filter(l=>!!l))).forEach(l=>{N.includes(l)||N.push(l)}),m(e,n,N,!1)},R.signal).then(n=>{const T=a.map(g=>g.id),l=Array.from(new Set([...C,...T])),$=b.map(g=>g.id).every(g=>l.includes(g));m(e,E?[]:n,l,$);const W=d.length+n.length;M({title:`搜索完成！${$?"总计":"当前"} ${W} 条结果`,radius:"lg",color:"success",timeout:2e3,classNames:{base:"bg-white/60 backdrop-blur-lg border-0"}})}).catch(n=>{n.name==="AbortError"?console.error("搜索已取消:",n):console.error("搜索时发生错误:",n)}).finally(()=>{i(!1)});M({title:"持续搜索内容中......",promise:O,radius:"lg",timeout:1,hideCloseButton:!0,classNames:{base:"bg-white/60 backdrop-blur-lg border-0"}})},s=y(e),w=b.map(a=>a.id);if(s){if(console.log("找到缓存的搜索结果:",s),v(s.results),s.isComplete){console.log("缓存已完成所有 API 搜索"),i(!1);return}const a=b.filter(d=>!s.completedApiIds.includes(d.id));if(a.length===0){console.log("所有选中的 API 都已缓存"),i(!1),m(e,[],w,!0);return}console.log(`还需搜索 ${a.length} 个 API:`,a.map(d=>d.name)),i(!0),await r(a,s.results,s.completedApiIds);return}console.log("没有缓存,开始全新搜索"),v([]),await r(b,[],[])},[b,y,m]);U(p?`${p}`:"搜索结果"),o.useEffect(()=>(i(!0),I(1),z(p),()=>{x.current?.abort()}),[p,z]),o.useEffect(()=>{let e=null;const r=()=>{const w=document.documentElement.scrollHeight,a=window.innerHeight;if(w<=a+8){S(!0);return}const d=w-((window.scrollY||window.pageYOffset)+a);S(d<50)},s=()=>{e&&window.clearTimeout(e),e=window.setTimeout(r,80)};return window.addEventListener("scroll",s,{passive:!0}),window.addEventListener("resize",s),r(),()=>{e&&window.clearTimeout(e),window.removeEventListener("scroll",s),window.removeEventListener("resize",s)}},[f.length,k]);const F=D?{base:"bg-transparent transition-all",wrapper:"px-[1vw] h-[5vh] rounded-full  bg-white/5 backdrop-blur-xl backdrop-saturate-150 supports-[backdrop-filter:blur(0)]:bg-white/10 supports-not-[backdrop-filter:blur(0)]:bg-white/10",item:"shadow-sm rounded-full bg-transparent text-black/80 data-[active=true]:text-black md:hover:cursor-pointer md:[&[data-hover=true]:not([data-active=true])]:!bg-black/10 [&[data-pressed=true]]:!bg-black/20",prev:"rounded-full bg-transparent text-black/70 data-[disabled=true]:text-black/30 md:hover:cursor-pointer md:[&[data-hover=true]:not([data-active=true])]:!bg-black/10 [&[data-pressed=true]]:!bg-black/20",next:"rounded-full bg-transparent text-black/70 data-[disabled=true]:text-black/30 md:hover:cursor-pointer md:[&[data-hover=true]:not([data-active=true])]:!bg-black/10 [&[data-pressed=true]]:!bg-black/20",cursor:"rounded-full bg-black/70 text-white backdrop-blur-sm"}:{base:"bg-transparent transition-all",wrapper:"px-[1vw] h-[5vh] rounded-full ring-1 ring-white/20 shadow-lg bg-white/10 backdrop-blur-xl backdrop-saturate-150 supports-[backdrop-filter:blur(0)]:bg-white/40 supports-not-[backdrop-filter:blur(0)]:bg-white/70",item:"rounded-full bg-transparent text-white/90 data-[active=true]:text-white md:hover:cursor-pointer md:[&[data-hover=true]:not([data-active=true])]:!bg-black/20 [&[data-pressed=true]]:!bg-black/30",prev:"rounded-full bg-transparent text-white/80 data-[disabled=true]:text-white/30 md:hover:cursor-pointer md:[&[data-hover=true]:not([data-active=true])]:!bg-black/20 [&[data-pressed=true]]:!bg-black/30",next:"rounded-full bg-transparent text-white/80 data-[disabled=true]:text-white/30 md:hover:cursor-pointer md:[&[data-hover=true]:not([data-active=true])]:!bg-black/20 [&[data-pressed=true]]:!bg-black/30",cursor:"rounded-full bg-black/60 backdrop-blur-sm"},H=e=>{I(e),window.scrollTo({top:0})};return t.jsxs("div",{className:"p-4 pt-20 sm:pt-4",children:[t.jsx(te,{}),!j&&f[k-1]?.length>0&&t.jsxs("div",{className:"flex flex-col items-center gap-10",children:[t.jsx("div",{className:"grid grid-cols-2 gap-[4vw] sm:grid-cols-3 md:gap-[2vw] xl:grid-cols-4",children:f[k-1]?.map((e,r)=>t.jsxs(B,{isPressable:!0,isFooterBlurred:!0,onPress:()=>q(`/detail/${e.source_code}/${e.vod_id}`),className:"flex h-[27vh] w-full items-center border-none transition-transform hover:scale-103 lg:h-[35vh]",radius:"lg",children:[t.jsxs(Y,{className:"absolute top-1 z-10 flex-col items-start p-3",children:[t.jsx("div",{className:"rounded-large bg-black/20 px-2 py-1 backdrop-blur",children:t.jsx("p",{className:"text-tiny font-bold text-white/80 uppercase",children:e.source_name})}),e.vod_remarks&&t.jsx(Z,{size:"sm",color:"warning",variant:"flat",className:"bg-warning/80 mt-2 backdrop-blur",children:e.vod_remarks})]}),t.jsx(G,{removeWrapper:!0,isZoomed:!0,isBlurred:!0,loading:"lazy",alt:e.vod_name,className:"z-0 h-full w-full object-cover",src:e.vod_pic||"https://placehold.jp/30/ffffff/000000/300x450.png?text=暂无封面"}),t.jsx(L,{className:"rounded-large shadow-small absolute bottom-[3%] z-10 min-h-[8vh] w-[92%] justify-between overflow-hidden border-1 border-white/20 py-2 backdrop-blur before:rounded-xl before:bg-white/10",children:t.jsxs("div",{className:"flex flex-grow flex-col gap-1 px-1",children:[t.jsxs("p",{className:"text-tiny text-white/80",children:[e.type_name," · ",e.vod_year]}),t.jsx("p",{className:"line-clamp-2 text-sm font-semibold text-white",children:e.vod_name})]})})]},`${e.source_code}_${e.vod_id}_${r}`))}),t.jsx("div",{className:"sticky bottom-[2vh] z-50 flex justify-center transition-all",children:t.jsx(J,{classNames:F,onChange:H,showControls:!0,size:window.innerWidth<640?"sm":"lg",initialPage:1,total:f.length})})]}),j&&t.jsx("div",{className:"grid grid-cols-2 gap-[4vw] sm:grid-cols-3 md:gap-[2vw] xl:grid-cols-4",children:new Array(h.singlePageSize).fill(null).map((e,r)=>t.jsxs(B,{isPressable:!0,isFooterBlurred:!0,className:"flex h-[27vh] w-full items-center border-none transition-transform hover:scale-103 lg:h-[35vh]",radius:"lg",children:[t.jsx(P,{className:"mt-[5%] h-[59%] w-[90%] rounded-lg md:h-[66%]"}),t.jsx(L,{className:"shadow-small absolute bottom-[4%] z-10 min-h-[8vh] w-[90%] justify-between overflow-hidden rounded-lg border-1 border-white/20 py-2 backdrop-blur before:rounded-xl before:bg-white/10",children:t.jsxs("div",{className:"flex flex-grow flex-col gap-3 px-1",children:[t.jsx(P,{className:"h-4 w-full rounded-lg md:h-5 md:w-[40%]"}),t.jsx(P,{className:"h-4 w-full rounded-lg md:h-5 md:w-[60%]"})]})})]},r))}),!j&&c?.length===0&&t.jsxs("div",{className:"flex flex-col items-center py-20",children:[t.jsx(re,{size:200}),t.jsx("p",{className:"text-gray-500",children:"没有找到相关内容，试试别的关键词吧~"})]})]})}export{ne as default};
