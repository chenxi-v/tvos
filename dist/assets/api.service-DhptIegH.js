import{r as v}from"./react-vendor-CM6QddGd.js";import{m as _,c as g,n as y,o as E}from"./index-WylA89_W.js";function b(p,t="Ouonnki TV"){v.useEffect(()=>{const e=document.title;return p?document.title=`${p} - ${t}`:document.title=t,()=>{document.title=e}},[p,t])}class A{getProxyUrl(t,e){if(e?.proxyUrl)return _(t,e.proxyUrl);const{proxy:r}=g.getState();return r.enabled&&r.proxyUrl?_(t,r.proxyUrl):_(t)}async fetchWithTimeout(t,e={},r=1e4,o=3){const n=new AbortController,i=setTimeout(()=>{n.abort("request timeout")},r);try{const s=await fetch(t,{...e,signal:n.signal});return clearTimeout(i),s}catch(s){if(clearTimeout(i),o>0)return console.warn(`请求失败，正在重试 (剩余${o}次):`,s),this.fetchWithTimeout(t,e,r,o-1);throw s}}buildApiUrl(t,e,r){const o=t.replace(/\/+$/,""),[n,i]=e.split("?");if(o.toLowerCase().endsWith(n.replace(/\/+$/,"").toLowerCase())||o.toLowerCase().includes("/api.php/provide/vod")){const s=o.includes("?")?"&":"?";return`${o}${s}${i}${r}`}return`${o}${e}${r}`}async searchVideos(t,e){try{if(!t)throw new Error("缺少搜索参数");if(!e||!e.url)throw new Error("无效的API配置");const r=this.buildApiUrl(e.url,y.search.path,encodeURIComponent(t)),o=await this.fetchWithTimeout(this.getProxyUrl(r,e),{headers:y.search.headers},e.timeout,e.retry);if(!o.ok)throw new Error(`API请求失败: ${o.status}`);const n=await o.json();if(!n||!Array.isArray(n.list))throw new Error("API返回的数据格式无效");return n.list.forEach(i=>{i.source_name=e.name,i.source_code=e.id,i.api_url=e.url}),{code:200,list:n.list||[]}}catch(r){return console.error("搜索错误:",r),{code:400,msg:r instanceof Error?r.message:"请求处理失败",list:[]}}}async getVideoDetail(t,e){try{if(!t)throw new Error("缺少视频ID参数");if(!/^[\w-]+$/.test(t))throw new Error("无效的视频ID格式");if(!e||!e.url)throw new Error("无效的API配置");const r=e.detailUrl||e.url,o=this.buildApiUrl(r,y.detail.path,t),n=await this.fetchWithTimeout(this.getProxyUrl(o,e),{headers:y.detail.headers});if(!n.ok)throw new Error(`详情请求失败: ${n.status}`);const i=await n.json();if(!i||!i.list||!Array.isArray(i.list)||i.list.length===0)throw new Error("获取到的详情内容无效");const s=i.list[0];let u=[],h=[];if(s.vod_play_url){const c=s.vod_play_url.split("$$$"),d=(s.vod_play_from||"").split("$$$");if(c.length>0){let a=d.findIndex(l=>l.toLowerCase().includes("m3u8"));a===-1&&(a=c.length-1),a>=c.length&&(a=c.length-1);const f=c[a].split("#");u=f.map(l=>{const w=l.split("$");return w.length>1?w[1]:""}).filter(l=>l&&(l.startsWith("http://")||l.startsWith("https://"))),h=f.map((l,w)=>{const $=l.split("$");return $.length>1?$[0]:`第${w+1}集`})}}return u.length===0&&s.vod_content&&(u=(s.vod_content.match(E)||[]).map(d=>d.replace(/^\$/,""))),{code:200,episodes:u,detailUrl:o,videoInfo:{title:s.vod_name,cover:s.vod_pic,desc:s.vod_content,type:s.type_name,year:s.vod_year,area:s.vod_area,director:s.vod_director,actor:s.vod_actor,remarks:s.vod_remarks,source_name:e.name,source_code:e.id,episodes_names:h}}}catch(r){return console.error("详情获取错误:",r),{code:400,msg:r instanceof Error?r.message:"请求处理失败",episodes:[]}}}createConcurrencyLimiter(t){let e=0;const r=[],o=()=>{for(;e<t&&r.length>0;){const n=r.shift();n&&(e++,n())}};return n=>new Promise((i,s)=>{const u=()=>{n().then(i).catch(s).finally(()=>{e--,o()})};r.push(u),o()})}aggregatedSearch(t,e,r,o){if(e.length===0)return console.warn("没有选中任何 API 源"),Promise.resolve([]);let n=!1;if(o){if(o.aborted)return Promise.reject(new DOMException("Aborted","AbortError"));o.addEventListener("abort",()=>{n=!0})}const i=new Set,s=this.createConcurrencyLimiter(3),u=e.map(c=>s(async()=>{if(n)return[];let d=[];try{d=await this.searchSingleSource(t,c)}catch(m){if(n)return[];console.warn(`${c.name} 源搜索失败:`,m)}if(n)return[];const a=d.filter(m=>{const f=`${m.source_code}_${m.vod_id}`;return i.has(f)?!1:(i.add(f),!0)});return n||a.length===0?[]:(r(a),a)})),h=Promise.all(u).then(c=>c.flat());if(o){const c=new Promise((d,a)=>{o.addEventListener("abort",()=>{a(new DOMException("Aborted","AbortError"))})});return Promise.race([h,c])}return h}async searchSingleSource(t,e){try{const r=await this.searchVideos(t,e);return r.code===200&&r.list?r.list:[]}catch(r){return console.warn(`${e.name}源搜索失败:`,r),[]}}}const U=new A;export{U as a,b as u};
